<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a237e">
    <title>Fakir Apparels - Washing Plant (Online Database)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #1a237e;
            --secondary-blue: #283593;
            --accent-green: #2e7d32;
            --accent-yellow: #ffd600;
            --warning-yellow: #fff8e1;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --dark-gray: #424242;
            --white: #ffffff;
            --error-red: #d32f2f;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            line-height: 1.6;
            min-height: 100vh;
        }

        .screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .hidden {
            display: none !important;
        }

        /* ===== LOGIN SCREEN ===== */
        .login-container {
            max-width: 450px;
            margin: auto;
            padding: 30px;
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        .logo-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .company-logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
            box-shadow: 0 8px 25px rgba(26, 35, 126, 0.3);
        }

        .logo-header h1 {
            color: var(--primary-blue);
            font-size: 1.8rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .logo-header h2 {
            color: var(--secondary-blue);
            font-size: 1.3rem;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .security-badge {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .login-form {
            padding: 20px 0;
        }

        .login-form h3 {
            text-align: center;
            margin-bottom: 25px;
            color: var(--primary-blue);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark-gray);
            font-weight: 600;
            font-size: 0.95rem;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--medium-gray);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: var(--white);
        }

        .input-group input:focus, .input-group select:focus {
            border-color: var(--primary-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }

        .password-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            background: none;
            border: none;
            color: var(--dark-gray);
            cursor: pointer;
            padding: 8px;
            font-size: 1.1rem;
            transition: color 0.2s;
        }

        .password-toggle:hover {
            color: var(--primary-blue);
        }

        /* ===== BUTTONS ===== */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(26, 35, 126, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--accent-green), #4caf50);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(46, 125, 50, 0.3);
        }

        .btn-download {
            background: linear-gradient(135deg, #ff9800, #ff5722);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s;
        }

        .btn-download:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 152, 0, 0.3);
        }

        .btn-pdf {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s;
        }

        .btn-pdf:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(211, 47, 47, 0.3);
        }

        .btn-small {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-small:hover {
            background: var(--secondary-blue);
            transform: translateY(-1px);
        }

        .btn-remove-row {
            background: var(--error-red);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-remove-row:hover {
            background: #b71c1c;
            transform: scale(1.05);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* ===== APP HEADER ===== */
        .app-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: var(--white);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-logo {
            flex-shrink: 0;
        }

        .header-logo .company-logo {
            height: 60px;
            width: 60px;
            margin: 0;
            font-size: 20px;
        }

        .header-info {
            flex: 1;
        }

        .header-info h1 {
            font-size: 1.3rem;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .header-details {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            font-size: 0.95rem;
        }

        .detail-item {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .detail-item .label {
            opacity: 0.9;
            font-weight: 500;
        }

        .detail-item .value {
            font-weight: 700;
            color: var(--accent-yellow);
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* ===== FORM SECTIONS ===== */
        .report-header-section {
            background: var(--white);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 5px solid var(--primary-blue);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-blue);
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--medium-gray);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }

        .input-section {
            background: var(--white);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 5px solid var(--accent-green);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-header h2 {
            font-size: 1.4rem;
            color: var(--primary-blue);
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
        }

        /* ===== TABLES ===== */
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
            border: 2px solid var(--medium-gray);
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .data-table th {
            background: var(--primary-blue);
            color: white;
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--medium-gray);
            vertical-align: middle;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table input, .data-table select {
            width: 100%;
            padding: 10px;
            border: 1.5px solid var(--medium-gray);
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.2s;
            background: var(--white);
        }

        .data-table input:focus, .data-table select:focus {
            border-color: var(--primary-blue);
            outline: none;
            box-shadow: 0 0 0 2px rgba(26, 35, 126, 0.1);
        }

        .re-wash-row {
            background-color: var(--warning-yellow) !important;
            border-left: 4px solid var(--accent-yellow);
        }

        /* ===== SECTION TOTALS ===== */
        .section-total {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 18px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2rem;
            border: 2px solid var(--medium-gray);
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-total strong {
            color: var(--primary-blue);
            font-size: 1.3rem;
        }

        .section-total span {
            font-weight: bold;
            color: var(--accent-green);
            font-size: 1.4rem;
            background: white;
            padding: 8px 20px;
            border-radius: 8px;
            border: 2px solid var(--accent-green);
            min-width: 120px;
        }

        .panel-wash-input {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .panel-wash-input label {
            font-weight: 700;
            color: var(--primary-blue);
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .panel-wash-input input {
            flex: 1;
            max-width: 250px;
            padding: 16px;
            border: 3px solid var(--medium-gray);
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            transition: all 0.3s;
        }

        .panel-wash-input input:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(26, 35, 126, 0.15);
        }

        /* ===== ACTION BUTTONS ===== */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 40px 0;
            padding: 30px;
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        @media (min-width: 768px) {
            .action-buttons {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .action-buttons button {
                flex: 1;
                min-width: 200px;
            }
        }

        /* ===== REPORT PREVIEW ===== */
        #reportPreview {
            background: var(--white);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 40px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 3px solid var(--primary-blue);
        }

        #reportPreview h3 {
            margin-bottom: 20px;
            color: var(--primary-blue);
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--light-gray);
        }

        .preview-container {
            border: 3px solid var(--medium-gray);
            border-radius: 12px;
            overflow: hidden;
            background: white;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-image {
            width: 100%;
            height: auto;
            display: block;
            max-width: 100%;
            border-radius: 8px;
        }

        .preview-placeholder {
            text-align: center;
            padding: 50px;
            color: var(--dark-gray);
            font-size: 1.1rem;
        }

        .preview-placeholder i {
            font-size: 64px;
            color: var(--medium-gray);
            margin-bottom: 20px;
        }

        /* ===== LOADING OVERLAY ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            text-align: center;
            background: var(--white);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid var(--light-gray);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-content p {
            font-size: 1.1rem;
            color: var(--primary-blue);
            font-weight: 600;
            margin-top: 15px;
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-blue);
            color: white;
            padding: 16px 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideUp 0.3s ease;
            max-width: 500px;
            width: 90%;
            font-weight: 500;
        }

        .toast.error {
            background: var(--error-red);
        }

        .toast.success {
            background: var(--accent-green);
        }

        .toast.warning {
            background: #ff9800;
        }

        .toast.info {
            background: #2196f3;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* ===== DEVICE REGISTRATION ===== */
        .device-registration {
            background: var(--warning-yellow);
            padding: 18px;
            border-radius: 10px;
            margin-top: 25px;
            text-align: center;
            border: 2px solid #ffd600;
        }

        .device-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .device-fingerprint {
            font-family: monospace;
            color: var(--dark-gray);
            font-size: 0.85rem;
            word-break: break-all;
            background: rgba(255, 255, 255, 0.7);
            padding: 8px;
            border-radius: 6px;
            margin-top: 5px;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            .login-container {
                padding: 20px;
                margin: 20px;
            }
            
            .app-header {
                padding: 15px;
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .header-details {
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .input-section,
            .report-header-section {
                padding: 20px;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .section-total {
                flex-direction: column;
                text-align: center;
            }
            
            .panel-wash-input {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .panel-wash-input input {
                max-width: 100%;
                width: 100%;
            }
            
            .toast {
                width: 95%;
                padding: 14px 20px;
            }
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            body * {
                visibility: hidden;
            }
            #reportPreview,
            #reportPreview * {
                visibility: visible;
            }
            #reportPreview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                border: none;
                box-shadow: none;
            }
            
            .preview-container {
                border: none;
                border-radius: 0;
            }
            
            button {
                display: none !important;
            }
        }

        /* ===== ONLINE STATUS ===== */
        .online-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--accent-green);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .online-status.offline {
            background: var(--error-red);
        }

        .recent-reports {
            background: var(--white);
            padding: 25px;
            border-radius: 12px;
            margin-top: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .report-card {
            background: #f8f9fa;
            border: 2px solid var(--medium-gray);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .report-card:hover {
            border-color: var(--primary-blue);
            background: #f0f7ff;
        }

        .report-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .report-id {
            font-weight: bold;
            color: var(--primary-blue);
            font-size: 1.1rem;
        }

        .report-date {
            color: var(--dark-gray);
            font-size: 0.9rem;
        }

        .report-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .report-detail {
            text-align: center;
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--light-gray);
        }

        .report-detail strong {
            display: block;
            color: var(--primary-blue);
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <!-- Online Status Indicator -->
    <div id="onlineStatus" class="online-status hidden">
        <i class="fas fa-wifi"></i>
        <span>Online Mode</span>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="screen">
        <div class="login-container">
            <div class="logo-header">
                <div class="company-logo">FA</div>
                <h1>FAKIR APPARELS LTD</h1>
                <h2>Washing Plant Supervisor Portal</h2>
                <div class="security-badge">
                    <i class="fas fa-database"></i> Online Database System
                </div>
            </div>
            
            <div class="login-form">
                <h3><i class="fas fa-user-lock"></i> Supervisor Login</h3>
                
                <div class="input-group">
                    <label for="supervisorName"><i class="fas fa-user"></i> Select Supervisor</label>
                    <select id="supervisorName" required style="padding: 14px; font-size: 16px;">
                        <option value="">-- Select Your Name --</option>
                        <option value="Soriful">Soriful</option>
                        <option value="Hasan">Hasan</option>
                        <option value="Junayed">Junayed</option>
                        <option value="Rashid">Rashid</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="loginEmail"><i class="fas fa-envelope"></i> Email Address</label>
                    <input type="email" 
                           id="loginEmail" 
                           placeholder="Enter your company email" 
                           required
                           autocomplete="username">
                </div>
                
                <div class="input-group">
                    <label for="loginPassword"><i class="fas fa-key"></i> Password</label>
                    <div class="password-input-container">
                        <input type="password" 
                               id="loginPassword" 
                               placeholder="Enter your password" 
                               required
                               autocomplete="current-password">
                        <button type="button" class="password-toggle" id="togglePasswordVisibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div style="font-size: 0.85rem; color: var(--dark-gray); margin-top: 5px; text-align: center;">
                        Use: washing@fakirapparels.com / Fakir@2024
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="apiUrl"><i class="fas fa-server"></i> API URL (Optional)</label>
                    <input type="text" 
                           id="apiUrl" 
                           placeholder="Leave empty for demo mode"
                           value="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
                </div>
                
                <button id="loginBtn" class="btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Login to Dashboard
                </button>
                
                <div class="device-registration">
                    <div class="device-info">
                        <i class="fas fa-mobile-alt"></i>
                        <span id="deviceStatus">This device will be registered for secure access</span>
                    </div>
                    <div class="device-fingerprint">
                        Device ID: <span id="deviceIdDisplay"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application Screen -->
    <div id="appScreen" class="screen hidden">
        <!-- Header -->
        <header class="app-header">
            <div class="header-logo">
                <div class="company-logo">FA</div>
            </div>
            <div class="header-info">
                <h1>DAILY WASHING PRODUCTION REPORT SYSTEM</h1>
                <div class="header-details">
                    <div class="detail-item">
                        <span class="label">Date:</span>
                        <span id="currentDate" class="value"></span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Supervisor:</span>
                        <span id="loggedInSupervisor" class="value"></span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Mode:</span>
                        <span id="connectionMode" class="value">Online</span>
                    </div>
                </div>
            </div>
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </header>

        <main class="main-content">
            <!-- Report Header Section -->
            <section class="report-header-section">
                <h2><i class="fas fa-file-alt"></i> DAILY REPORT INFORMATION</h2>
                <div class="form-group">
                    <label for="reportDate"><i class="fas fa-calendar-day"></i> Report Date</label>
                    <input type="date" id="reportDate" required>
                </div>
                <div class="form-group">
                    <label for="shiftResponsible"><i class="fas fa-user-tie"></i> Shift Responsible Person</label>
                    <input type="text" id="shiftResponsible" placeholder="Enter name of shift responsible person" required>
                </div>
            </section>

            <!-- 1ï¸âƒ£ Production Input Section -->
            <section class="input-section">
                <div class="section-header">
                    <h2><i class="fas fa-industry"></i> 1. PRODUCTION INPUT</h2>
                    <div>
                        <button id="addProductionRow" class="btn-small">
                            <i class="fas fa-plus-circle"></i> Add New Row
                        </button>
                        <button id="clearProduction" class="btn-small" style="background: var(--error-red); margin-left: 10px;">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="productionTable" class="data-table">
                        <thead>
                            <tr>
                                <th width="25%">Buyer Name</th>
                                <th width="20%">Style Code</th>
                                <th width="15%">Colour Code</th>
                                <th width="20%">Type of Wash</th>
                                <th width="15%">Quantity (pcs)</th>
                                <th width="5%">Action</th>
                            </tr>
                        </thead>
                        <tbody id="productionTableBody">
                            <!-- Rows will be added dynamically -->
                        </tbody>
                    </table>
                </div>
                <div class="section-total">
                    <strong>ðŸ“Š TOTAL PRODUCTION QUANTITY:</strong>
                    <span id="productionTotal">0</span> pcs
                </div>
            </section>

            <!-- 2ï¸âƒ£ QC Pass Input Section -->
            <section class="input-section">
                <div class="section-header">
                    <h2><i class="fas fa-check-double"></i> 2. QUALITY CONTROL PASS INPUT</h2>
                    <div>
                        <button id="addQcRow" class="btn-small">
                            <i class="fas fa-plus-circle"></i> Add New Row
                        </button>
                        <button id="clearQC" class="btn-small" style="background: var(--error-red); margin-left: 10px;">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="qcTable" class="data-table">
                        <thead>
                            <tr>
                                <th width="25%">Buyer Name</th>
                                <th width="20%">Style Code</th>
                                <th width="15%">Colour Code</th>
                                <th width="20%">Type of Wash</th>
                                <th width="15%">Passed Quantity</th>
                                <th width="5%">Action</th>
                            </tr>
                        </thead>
                        <tbody id="qcTableBody">
                            <!-- Rows will be added dynamically -->
                        </tbody>
                    </table>
                </div>
                <div class="section-total">
                    <strong>âœ… TOTAL QC PASS QUANTITY:</strong>
                    <span id="qcTotal">0</span> pcs
                </div>
            </section>

            <!-- 3ï¸âƒ£ Panel Wash Input -->
            <section class="input-section">
                <div class="section-header">
                    <h2><i class="fas fa-tshirt"></i> 3. PANEL WASH SUMMARY</h2>
                </div>
                <div class="panel-wash-input">
                    <label for="panelWashRolls"><i class="fas fa-roll"></i> Total Roll Processed:</label>
                    <input type="number" id="panelWashRolls" min="0" value="0" required>
                </div>
            </section>

            <!-- Action Buttons -->
            <section class="action-buttons">
                <button id="submitDataBtn" class="btn-primary">
                    <i class="fas fa-paper-plane"></i> SUBMIT TO ONLINE DATABASE
                </button>
                <button id="generateReportBtn" class="btn-success">
                    <i class="fas fa-file-image"></i> GENERATE PNG REPORT
                </button>
                <button id="generatePdfBtn" class="btn-pdf">
                    <i class="fas fa-file-pdf"></i> GENERATE PDF REPORT
                </button>
                <button id="downloadReportBtn" class="btn-download" disabled>
                    <i class="fas fa-download"></i> DOWNLOAD PNG
                </button>
                <button id="viewReportsBtn" class="btn-small" style="background: #9c27b0;">
                    <i class="fas fa-history"></i> View Previous Reports
                </button>
            </section>

            <!-- Report Preview Section -->
            <div id="reportPreview" class="hidden">
                <h3><i class="fas fa-eye"></i> REPORT PREVIEW</h3>
                <div class="preview-container">
                    <div id="reportPlaceholder" class="preview-placeholder">
                        <i class="fas fa-file-image"></i>
                        <h3>Your Report Will Appear Here</h3>
                        <p>Click "Generate PNG Report" to create your daily washing report</p>
                    </div>
                    <img id="generatedReport" alt="Generated Report" class="preview-image hidden">
                </div>
                <div style="text-align: center; margin-top: 25px;">
                    <button onclick="window.print()" class="btn-small" style="background: var(--primary-blue);">
                        <i class="fas fa-print"></i> Print Report
                    </button>
                    <button id="shareReportBtn" class="btn-small" style="background: #2196f3; margin-left: 10px;">
                        <i class="fas fa-share"></i> Share Report
                    </button>
                </div>
            </div>

            <!-- Recent Reports Section -->
            <div id="recentReportsSection" class="recent-reports hidden">
                <h3><i class="fas fa-history"></i> PREVIOUSLY SUBMITTED REPORTS</h3>
                <div id="reportsList">
                    <!-- Reports will be loaded here -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button id="refreshReportsBtn" class="btn-small">
                        <i class="fas fa-sync-alt"></i> Refresh Reports
                    </button>
                    <button id="hideReportsBtn" class="btn-small" style="background: var(--error-red); margin-left: 10px;">
                        <i class="fas fa-times"></i> Hide Reports
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingText">Processing your request...</p>
        </div>
    </div>

    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // ========== CONFIGURATION ==========
        const CONFIG = {
            VALID_EMAIL: "washing@fakirapparels.com",
            VALID_PASSWORD: "Fakir@2024",
            DEFAULT_API_URL: "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec",
            OFFLINE_MODE: false
        };

        // ========== GLOBAL VARIABLES ==========
        let currentSupervisor = null;
        let reportData = null;
        let deviceId = null;
        let apiUrl = null;
        let isOnline = true;

        // ========== DOM ELEMENTS ==========
        const loginScreen = document.getElementById('loginScreen');
        const appScreen = document.getElementById('appScreen');
        const onlineStatus = document.getElementById('onlineStatus');
        const connectionMode = document.getElementById('connectionMode');
        const loginBtn = document.getElementById('loginBtn');
        const supervisorName = document.getElementById('supervisorName');
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const apiUrlInput = document.getElementById('apiUrl');
        const togglePasswordVisibility = document.getElementById('togglePasswordVisibility');
        const deviceIdDisplay = document.getElementById('deviceIdDisplay');
        const currentDateEl = document.getElementById('currentDate');
        const loggedInSupervisorEl = document.getElementById('loggedInSupervisor');
        const reportDate = document.getElementById('reportDate');
        const shiftResponsible = document.getElementById('shiftResponsible');
        const productionTableBody = document.getElementById('productionTableBody');
        const qcTableBody = document.getElementById('qcTableBody');
        const addProductionRowBtn = document.getElementById('addProductionRow');
        const addQcRowBtn = document.getElementById('addQcRow');
        const clearProductionBtn = document.getElementById('clearProduction');
        const clearQCBtn = document.getElementById('clearQC');
        const productionTotalEl = document.getElementById('productionTotal');
        const qcTotalEl = document.getElementById('qcTotal');
        const panelWashRolls = document.getElementById('panelWashRolls');
        const submitDataBtn = document.getElementById('submitDataBtn');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const generatePdfBtn = document.getElementById('generatePdfBtn');
        const downloadReportBtn = document.getElementById('downloadReportBtn');
        const viewReportsBtn = document.getElementById('viewReportsBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const reportPreview = document.getElementById('reportPreview');
        const reportPlaceholder = document.getElementById('reportPlaceholder');
        const generatedReportImg = document.getElementById('generatedReport');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const shareReportBtn = document.getElementById('shareReportBtn');
        const recentReportsSection = document.getElementById('recentReportsSection');
        const reportsList = document.getElementById('reportsList');
        const refreshReportsBtn = document.getElementById('refreshReportsBtn');
        const hideReportsBtn = document.getElementById('hideReportsBtn');

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Fakir Apparels Online System Initializing...');
            
            // Generate device ID
            deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('fakir_device_id', deviceId);
            deviceIdDisplay.textContent = deviceId.substring(0, 15) + '...';
            
            // Set today's date
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            reportDate.value = todayStr;
            currentDateEl.textContent = formatDate(todayStr);
            
            // Set default email
            loginEmail.value = CONFIG.VALID_EMAIL;
            apiUrlInput.value = CONFIG.DEFAULT_API_URL;
            
            // Check for existing session
            checkExistingSession();
            
            // Initialize form with one row each
            addProductionRow(true);
            addQcRow(true);
            
            // Setup event listeners
            setupEventListeners();
            
            // Check online status
            checkOnlineStatus();
            
            console.log('System initialized successfully');
        });

        function setupEventListeners() {
            // Login
            loginBtn.addEventListener('click', handleLogin);
            togglePasswordVisibility.addEventListener('click', togglePasswordVisibilityHandler);
            loginPassword.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
            
            // Form actions
            addProductionRowBtn.addEventListener('click', () => addProductionRow(false));
            addQcRowBtn.addEventListener('click', () => addQcRow(false));
            clearProductionBtn.addEventListener('click', clearProductionTable);
            clearQCBtn.addEventListener('click', clearQCTable);
            
            // Data handling
            submitDataBtn.addEventListener('click', submitDataToAPI);
            generateReportBtn.addEventListener('click', generatePNGReport);
            generatePdfBtn.addEventListener('click', generateMultiPagePDF);
            downloadReportBtn.addEventListener('click', downloadReport);
            viewReportsBtn.addEventListener('click', loadRecentReports);
            logoutBtn.addEventListener('click', handleLogout);
            shareReportBtn.addEventListener('click', shareReport);
            refreshReportsBtn.addEventListener('click', loadRecentReports);
            hideReportsBtn.addEventListener('click', () => recentReportsSection.classList.add('hidden'));
            
            // Auto-save form
            reportDate.addEventListener('change', saveFormState);
            shiftResponsible.addEventListener('input', saveFormState);
            panelWashRolls.addEventListener('input', saveFormState);
            
            // Auto-calculate totals
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('quantity-input') || 
                    e.target.classList.contains('qc-quantity') ||
                    e.target.classList.contains('wash-type') ||
                    e.target.classList.contains('qc-wash-type')) {
                    calculateTotals();
                    saveFormState();
                }
            });
        }

        // ========== ONLINE/OFFLINE MANAGEMENT ==========
        function checkOnlineStatus() {
            if (apiUrlInput.value && !apiUrlInput.value.includes('YOUR_SCRIPT_ID')) {
                fetch(apiUrlInput.value + '?test=true')
                    .then(response => {
                        isOnline = response.ok;
                        updateOnlineStatus();
                    })
                    .catch(() => {
                        isOnline = false;
                        updateOnlineStatus();
                    });
            }
        }

        function updateOnlineStatus() {
            if (isOnline) {
                onlineStatus.classList.remove('hidden');
                onlineStatus.classList.remove('offline');
                onlineStatus.innerHTML = '<i class="fas fa-wifi"></i> Online Mode';
                connectionMode.textContent = 'Online';
                submitDataBtn.innerHTML = '<i class="fas fa-paper-plane"></i> SUBMIT TO ONLINE DATABASE';
            } else {
                onlineStatus.classList.remove('hidden');
                onlineStatus.classList.add('offline');
                onlineStatus.innerHTML = '<i class="fas fa-wifi-slash"></i> Offline Mode';
                connectionMode.textContent = 'Offline';
                submitDataBtn.innerHTML = '<i class="fas fa-save"></i> SAVE LOCALLY';
            }
        }

        // ========== API FUNCTIONS ==========
        async function callAPI(action, data = {}) {
            if (!isOnline || !apiUrl) {
                return { success: false, error: 'Offline mode' };
            }
            
            try {
                const payload = {
                    action: action,
                    ...data,
                    deviceId: deviceId,
                    timestamp: new Date().toISOString()
                };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                isOnline = false;
                updateOnlineStatus();
                return { success: false, error: 'API connection failed' };
            }
        }

        // ========== AUTHENTICATION ==========
        function checkExistingSession() {
            const session = localStorage.getItem('fakir_session');
            if (session) {
                try {
                    const sessionData = JSON.parse(session);
                    if (Date.now() < sessionData.expiresAt) {
                        currentSupervisor = sessionData.supervisor;
                        apiUrl = sessionData.apiUrl || CONFIG.DEFAULT_API_URL;
                        showAppScreen();
                        showToast(`Welcome back, ${currentSupervisor.name}!`, 'success');
                    } else {
                        localStorage.removeItem('fakir_session');
                    }
                } catch (e) {
                    localStorage.removeItem('fakir_session');
                }
            }
        }

        async function handleLogin() {
            const name = supervisorName.value;
            const email = loginEmail.value.trim();
            const password = loginPassword.value;
            apiUrl = apiUrlInput.value.trim() || CONFIG.DEFAULT_API_URL;
            
            if (!name) {
                showToast('Please select your name from the list', 'error');
                return;
            }
            
            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }
            
            if (apiUrl.includes('YOUR_SCRIPT_ID')) {
                if (email !== CONFIG.VALID_EMAIL || password !== CONFIG.VALID_PASSWORD) {
                    showToast('Invalid email or password. Use: washing@fakirapparels.com / Fakir@2024', 'error');
                    return;
                }
                
                currentSupervisor = {
                    name: name,
                    email: email,
                    loginTime: new Date().toISOString(),
                    deviceId: deviceId
                };
                
                isOnline = false;
                updateOnlineStatus();
                
            } else {
                showLoading('Connecting to online database...');
                
                try {
                    const result = await callAPI('login', {
                        email: email,
                        password: password,
                        supervisorName: name
                    });
                    
                    if (result.success) {
                        currentSupervisor = result.supervisor;
                        isOnline = true;
                    } else {
                        showToast(result.error || 'Login failed', 'error');
                        hideLoading();
                        return;
                    }
                } catch (error) {
                    showToast('Cannot connect to server. Using offline mode.', 'warning');
                    isOnline = false;
                    if (email !== CONFIG.VALID_EMAIL || password !== CONFIG.VALID_PASSWORD) {
                        showToast('Invalid credentials', 'error');
                        hideLoading();
                        return;
                    }
                    currentSupervisor = {
                        name: name,
                        email: email,
                        loginTime: new Date().toISOString(),
                        deviceId: deviceId
                    };
                } finally {
                    hideLoading();
                }
            }
            
            const sessionData = {
                supervisor: currentSupervisor,
                apiUrl: apiUrl,
                createdAt: Date.now(),
                expiresAt: Date.now() + (12 * 60 * 60 * 1000)
            };
            localStorage.setItem('fakir_session', JSON.stringify(sessionData));
            
            showAppScreen();
            showToast(`Welcome, ${name}! ${isOnline ? '(Online Mode)' : '(Offline Mode)'}`, 'success');
            
            if (isOnline) {
                await callAPI('logActivity', {
                    action: 'LOGIN_SUCCESS',
                    details: name
                });
            }
        }

        function togglePasswordVisibilityHandler() {
            const type = loginPassword.getAttribute('type');
            if (type === 'password') {
                loginPassword.setAttribute('type', 'text');
                togglePasswordVisibility.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                loginPassword.setAttribute('type', 'password');
                togglePasswordVisibility.innerHTML = '<i class="fas fa-eye"></i>';
            }
        }

        // ========== FORM MANAGEMENT ==========
        function addProductionRow(isInitial = false) {
            const row = document.createElement('tr');
            row.className = 'production-row';
            row.innerHTML = `
                <td><input type="text" class="buyer-input" placeholder="e.g., H&M, Zara" ${isInitial ? 'value="H&M"' : ''} required></td>
                <td><input type="text" class="style-input" placeholder="Style code" ${isInitial ? 'value="WM-2024"' : ''} required></td>
                <td><input type="text" class="color-input" placeholder="Colour" ${isInitial ? 'value="Navy Blue"' : ''} required></td>
                <td>
                    <select class="wash-type">
                        <option value="Fresh" ${isInitial ? 'selected' : ''}>Fresh Wash</option>
                        <option value="Re-Wash">Re-Wash</option>
                    </select>
                </td>
                <td><input type="number" class="quantity-input" min="1" placeholder="0" ${isInitial ? 'value="1250"' : ''} required></td>
                <td><button class="btn-remove-row" onclick="removeRow(this, 'production')"><i class="fas fa-times"></i></button></td>
            `;
            
            productionTableBody.appendChild(row);
            
            if (!isInitial) {
                setTimeout(() => row.querySelector('.buyer-input').focus(), 100);
            }
            
            calculateTotals();
            saveFormState();
        }

        function addQcRow(isInitial = false) {
            const row = document.createElement('tr');
            row.className = 'qc-row';
            row.innerHTML = `
                <td><input type="text" class="qc-buyer" placeholder="e.g., H&M, Zara" ${isInitial ? 'value="H&M"' : ''} required></td>
                <td><input type="text" class="qc-style" placeholder="Style code" ${isInitial ? 'value="WM-2024"' : ''} required></td>
                <td><input type="text" class="qc-color" placeholder="Colour" ${isInitial ? 'value="Navy Blue"' : ''} required></td>
                <td>
                    <select class="qc-wash-type">
                        <option value="Fresh" ${isInitial ? 'selected' : ''}>Fresh Wash</option>
                        <option value="Re-Wash">Re-Wash</option>
                    </select>
                </td>
                <td><input type="number" class="qc-quantity" min="0" placeholder="0" ${isInitial ? 'value="1200"' : ''} required></td>
                <td><button class="btn-remove-row" onclick="removeRow(this, 'qc')"><i class="fas fa-times"></i></button></td>
            `;
            
            qcTableBody.appendChild(row);
            calculateTotals();
            saveFormState();
        }

        function removeRow(button, type) {
            const row = button.closest('tr');
            row.style.opacity = '0';
            row.style.transform = 'translateX(-20px)';
            
            setTimeout(() => {
                row.remove();
                calculateTotals();
                saveFormState();
            }, 300);
        }

        function clearProductionTable() {
            if (productionTableBody.children.length > 0) {
                if (confirm('Are you sure you want to clear all production data?')) {
                    productionTableBody.innerHTML = '';
                    addProductionRow(false);
                    calculateTotals();
                    saveFormState();
                    showToast('Production table cleared', 'info');
                }
            }
        }

        function clearQCTable() {
            if (qcTableBody.children.length > 0) {
                if (confirm('Are you sure you want to clear all QC data?')) {
                    qcTableBody.innerHTML = '';
                    addQcRow(false);
                    calculateTotals();
                    saveFormState();
                    showToast('QC table cleared', 'info');
                }
            }
        }

        function calculateTotals() {
            let productionTotal = 0;
            document.querySelectorAll('.quantity-input').forEach(input => {
                const value = parseInt(input.value) || 0;
                productionTotal += value;
                
                const row = input.closest('tr');
                const washType = row.querySelector('.wash-type')?.value;
                if (washType === 'Re-Wash') {
                    row.classList.add('re-wash-row');
                } else {
                    row.classList.remove('re-wash-row');
                }
            });
            productionTotalEl.textContent = productionTotal.toLocaleString();
            
            let qcTotal = 0;
            document.querySelectorAll('.qc-quantity').forEach(input => {
                const value = parseInt(input.value) || 0;
                qcTotal += value;
                
                const row = input.closest('tr');
                const washType = row.querySelector('.qc-wash-type')?.value;
                if (washType === 'Re-Wash') {
                    row.classList.add('re-wash-row');
                } else {
                    row.classList.remove('re-wash-row');
                }
            });
            qcTotalEl.textContent = qcTotal.toLocaleString();
            
            return { productionTotal, qcTotal };
        }

        // ========== DATA HANDLING ==========
        function collectFormData() {
            const productionRows = [];
            let productionTotal = 0;
            
            document.querySelectorAll('.production-row').forEach((row, index) => {
                const buyer = row.querySelector('.buyer-input')?.value?.trim() || '';
                const style = row.querySelector('.style-input')?.value?.trim() || '';
                const color = row.querySelector('.color-input')?.value?.trim() || '';
                const washType = row.querySelector('.wash-type')?.value || 'Fresh';
                const quantity = parseInt(row.querySelector('.quantity-input')?.value) || 0;
                
                if (buyer && style && quantity > 0) {
                    productionRows.push({
                        buyer: buyer,
                        style: style,
                        colorCode: color,
                        washType: washType,
                        quantity: quantity
                    });
                    productionTotal += quantity;
                }
            });
            
            const qcRows = [];
            let qcTotal = 0;
            
            document.querySelectorAll('.qc-row').forEach((row, index) => {
                const buyer = row.querySelector('.qc-buyer')?.value?.trim() || '';
                const style = row.querySelector('.qc-style')?.value?.trim() || '';
                const color = row.querySelector('.qc-color')?.value?.trim() || '';
                const washType = row.querySelector('.qc-wash-type')?.value || 'Fresh';
                const passedQuantity = parseInt(row.querySelector('.qc-quantity')?.value) || 0;
                
                if (buyer && style) {
                    qcRows.push({
                        buyer: buyer,
                        style: style,
                        colorCode: color,
                        washType: washType,
                        passedQuantity: passedQuantity
                    });
                    qcTotal += passedQuantity;
                }
            });
            
            const data = {
                reportId: 'FAKIR-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6).toUpperCase(),
                date: reportDate.value,
                shiftResponsible: shiftResponsible.value.trim(),
                supervisor: currentSupervisor.name,
                productionData: productionRows,
                qcData: qcRows,
                panelWashRolls: parseInt(panelWashRolls.value) || 0,
                productionTotal: productionTotal,
                qcTotal: qcTotal,
                submissionTime: new Date().toISOString(),
                deviceId: deviceId
            };
            
            return data;
        }

        function validateForm() {
            if (!reportDate.value) {
                showToast('Please select report date', 'error');
                reportDate.focus();
                return false;
            }
            
            if (!shiftResponsible.value.trim()) {
                showToast('Please enter shift responsible name', 'error');
                shiftResponsible.focus();
                return false;
            }
            
            let hasValidProduction = false;
            document.querySelectorAll('.production-row').forEach(row => {
                const buyer = row.querySelector('.buyer-input')?.value?.trim();
                const style = row.querySelector('.style-input')?.value?.trim();
                const quantity = parseInt(row.querySelector('.quantity-input')?.value) || 0;
                
                if (buyer && style && quantity > 0) {
                    hasValidProduction = true;
                }
            });
            
            if (!hasValidProduction) {
                showToast('Please add at least one production row with valid data', 'error');
                return false;
            }
            
            return true;
        }

        async function submitDataToAPI() {
            if (!validateForm()) return;
            
            showLoading(isOnline ? 'Submitting to online database...' : 'Saving locally...');
            
            try {
                reportData = collectFormData();
                
                if (isOnline) {
                    const result = await callAPI('submitData', reportData);
                    
                    if (result.success) {
                        showToast('âœ… Data saved to online database!', 'success');
                        generateReportBtn.disabled = false;
                        generatePdfBtn.disabled = false;
                        saveReportToLocalStorage(reportData);
                    } else {
                        throw new Error(result.error || 'Submission failed');
                    }
                } else {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    saveReportToLocalStorage(reportData);
                    generateReportBtn.disabled = false;
                    generatePdfBtn.disabled = false;
                    showToast('âœ… Data saved locally! (Offline Mode)', 'warning');
                }
                
            } catch (error) {
                console.error('Submission error:', error);
                showToast('Error: ' + error.message, 'error');
                
                if (isOnline) {
                    showToast('Falling back to local storage', 'warning');
                    isOnline = false;
                    updateOnlineStatus();
                    saveReportToLocalStorage(reportData);
                    generateReportBtn.disabled = false;
                    generatePdfBtn.disabled = false;
                }
            } finally {
                hideLoading();
            }
        }

        // ========== REPORT MANAGEMENT ==========
        async function loadRecentReports() {
            showLoading('Loading previous reports...');
            recentReportsSection.classList.remove('hidden');
            
            try {
                let reports = [];
                
                if (isOnline) {
                    const result = await callAPI('getReports', {
                        supervisor: currentSupervisor.name
                    });
                    
                    if (result.success) {
                        reports = result.reports;
                    } else {
                        reports = getReportsFromLocalStorage();
                    }
                } else {
                    reports = getReportsFromLocalStorage();
                }
                
                displayReportsList(reports);
                
            } catch (error) {
                console.error('Error loading reports:', error);
                showToast('Failed to load reports', 'error');
            } finally {
                hideLoading();
            }
        }

        function displayReportsList(reports) {
            if (!reports || reports.length === 0) {
                reportsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h4>No reports found</h4>
                        <p>Submit your first report to see it here</p>
                    </div>
                `;
                return;
            }
            
            reportsList.innerHTML = '';
            
            reports.slice(0, 10).forEach(report => {
                const reportDate = new Date(report.timestamp || report.submittedAt).toLocaleDateString();
                
                const card = document.createElement('div');
                card.className = 'report-card';
                card.innerHTML = `
                    <div class="report-card-header">
                        <div class="report-id">${report.reportId}</div>
                        <div class="report-date">${reportDate}</div>
                    </div>
                    <div>
                        <strong>Shift:</strong> ${report.shiftResponsible}<br>
                        <strong>Supervisor:</strong> ${report.supervisor}
                    </div>
                    <div class="report-details">
                        <div class="report-detail">
                            <strong>Production</strong>
                            ${report.productionTotal ? report.productionTotal.toLocaleString() + ' pcs' : 'N/A'}
                        </div>
                        <div class="report-detail">
                            <strong>QC Pass</strong>
                            ${report.qcTotal ? report.qcTotal.toLocaleString() + ' pcs' : 'N/A'}
                        </div>
                        <div class="report-detail">
                            <strong>Panel Wash</strong>
                            ${report.panelWashRolls ? report.panelWashRolls + ' rolls' : 'N/A'}
                        </div>
                    </div>
                `;
                
                reportsList.appendChild(card);
            });
        }

        function getReportsFromLocalStorage() {
            const saved = localStorage.getItem('fakir_local_reports');
            return saved ? JSON.parse(saved) : [];
        }

        function saveReportToLocalStorage(data) {
            let reports = getReportsFromLocalStorage();
            reports.unshift({
                ...data,
                savedAt: new Date().toISOString(),
                source: isOnline ? 'online' : 'offline'
            });
            
            if (reports.length > 50) {
                reports = reports.slice(0, 50);
            }
            
            localStorage.setItem('fakir_local_reports', JSON.stringify(reports));
            localStorage.setItem('last_report_data', JSON.stringify(data));
        }

        // ========== MULTI-PAGE PDF REPORT GENERATION (MATCHING PNG FORMAT) ==========
        async function generateMultiPagePDF() {
            if (!reportData) {
                const lastReport = localStorage.getItem('last_report_data');
                if (lastReport) {
                    reportData = JSON.parse(lastReport);
                } else {
                    showToast('Please submit data first', 'error');
                    return;
                }
            }
            
            showLoading('Generating multi-page PDF report...');
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                let yPos = margin;
                let currentPage = 1;
                const totalPages = calculateTotalPages();
                
                // ====== PAGE 1: HEADER AND BASIC INFO ======
                // Watermark background
                doc.setFillColor(26, 35, 126, 0.05);
                doc.rect(0, 0, pageWidth, pageHeight, 'F');
                
                // Company Header
                doc.setTextColor(26, 35, 126);
                doc.setFontSize(32);
                doc.setFont('helvetica', 'bold');
                doc.text('FAKIR APPARELS LTD', pageWidth/2, yPos, { align: 'center' });
                
                yPos += 15;
                doc.setFontSize(24);
                doc.text('Washing Plant - Daily Report', pageWidth/2, yPos, { align: 'center' });
                
                // Separator line
                yPos += 10;
                doc.setDrawColor(26, 35, 126);
                doc.setLineWidth(2);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                
                // Report Details
                yPos += 20;
                const formattedDate = new Date(reportData.date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('Report Information', margin, yPos);
                yPos += 10;
                
                doc.setFont('helvetica', 'normal');
                doc.text(`Date: ${formattedDate}`, margin, yPos);
                doc.text(`Report ID: ${reportData.reportId}`, pageWidth/2, yPos);
                yPos += 8;
                doc.text(`Shift Responsible: ${reportData.shiftResponsible}`, margin, yPos);
                doc.text(`Supervisor: ${reportData.supervisor}`, pageWidth/2, yPos);
                
                // ====== PRODUCTION SECTION ======
                yPos += 20;
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.setFillColor(46, 125, 50);
                doc.rect(margin, yPos - 5, pageWidth - 2*margin, 10, 'F');
                doc.text('1. PRODUCTION INPUT', margin + 10, yPos + 2);
                
                yPos += 10;
                
                // Check if we need a new page for production table
                const productionTableHeight = calculateTableHeight(reportData.productionData.length);
                if (yPos + productionTableHeight > pageHeight - 50) {
                    addPageFooter(doc, currentPage, totalPages);
                    doc.addPage();
                    currentPage++;
                    yPos = margin;
                    
                    // Add header for new page
                    doc.setTextColor(26, 35, 126);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PRODUCTION INPUT (Continued)', margin, yPos);
                    yPos += 15;
                }
                
                // Production Table Header
                doc.setFillColor(26, 35, 126);
                doc.rect(margin, yPos, pageWidth - 2*margin, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                
                const prodColWidths = [40, 35, 30, 40, 25];
                const prodColPositions = calculateColumnPositions(margin, prodColWidths, pageWidth);
                
                doc.text('Buyer', prodColPositions[0] + 5, yPos + 6);
                doc.text('Style Code', prodColPositions[1] + 5, yPos + 6);
                doc.text('Colour', prodColPositions[2] + 5, yPos + 6);
                doc.text('Wash Type', prodColPositions[3] + 5, yPos + 6);
                doc.text('Quantity', prodColPositions[4] + prodColWidths[4] - 5, yPos + 6, { align: 'right' });
                
                yPos += 10;
                
                // Production Table Data
                let prodRowIndex = 0;
                let prodPageStart = 0;
                const maxRowsPerPage = Math.floor((pageHeight - yPos - 50) / 6);
                
                for (let i = 0; i < reportData.productionData.length; i++) {
                    const item = reportData.productionData[i];
                    
                    // Check if we need a new page
                    if (prodRowIndex >= maxRowsPerPage) {
                        addPageFooter(doc, currentPage, totalPages);
                        doc.addPage();
                        currentPage++;
                        yPos = margin;
                        
                        // Add continuation header
                        doc.setTextColor(26, 35, 126);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text('PRODUCTION INPUT (Continued)', margin, yPos);
                        yPos += 15;
                        
                        // Repeat table header
                        doc.setFillColor(26, 35, 126);
                        doc.rect(margin, yPos, pageWidth - 2*margin, 8, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Buyer', prodColPositions[0] + 5, yPos + 6);
                        doc.text('Style Code', prodColPositions[1] + 5, yPos + 6);
                        doc.text('Colour', prodColPositions[2] + 5, yPos + 6);
                        doc.text('Wash Type', prodColPositions[3] + 5, yPos + 6);
                        doc.text('Quantity', prodColPositions[4] + prodColWidths[4] - 5, yPos + 6, { align: 'right' });
                        yPos += 10;
                        
                        prodRowIndex = 0;
                        prodPageStart = i;
                    }
                    
                    // Alternate row colors
                    if (prodRowIndex % 2 === 0) {
                        doc.setFillColor(245, 245, 245);
                        doc.rect(margin, yPos - 4, pageWidth - 2*margin, 6, 'F');
                    }
                    
                    // Set text color for re-wash
                    if (item.washType === 'Re-Wash') {
                        doc.setTextColor(255, 87, 34);
                        doc.setFont('helvetica', 'bold');
                    } else {
                        doc.setTextColor(66, 66, 66);
                        doc.setFont('helvetica', 'normal');
                    }
                    
                    doc.text(item.buyer.substring(0, 15), prodColPositions[0] + 5, yPos);
                    doc.text(item.style.substring(0, 12), prodColPositions[1] + 5, yPos);
                    doc.text(item.colorCode.substring(0, 10), prodColPositions[2] + 5, yPos);
                    doc.text(item.washType, prodColPositions[3] + 5, yPos);
                    doc.text(item.quantity.toLocaleString(), prodColPositions[4] + prodColWidths[4] - 5, yPos, { align: 'right' });
                    
                    yPos += 6;
                    prodRowIndex++;
                }
                
                // Production Total
                yPos += 5;
                doc.setDrawColor(46, 125, 50);
                doc.setLineWidth(0.5);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 5;
                
                doc.setFillColor(232, 245, 233);
                doc.rect(margin, yPos - 4, pageWidth - 2*margin, 8, 'F');
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('TOTAL PRODUCTION', prodColPositions[3] + 5, yPos);
                doc.text(reportData.productionTotal.toLocaleString() + ' pcs', 
                        prodColPositions[4] + prodColWidths[4] - 5, yPos, { align: 'right' });
                
                // ====== QC SECTION ======
                yPos += 20;
                
                // Check if we need a new page for QC section
                const qcTableHeight = calculateTableHeight(reportData.qcData.length);
                if (yPos + qcTableHeight > pageHeight - 50) {
                    addPageFooter(doc, currentPage, totalPages);
                    doc.addPage();
                    currentPage++;
                    yPos = margin;
                }
                
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.setFillColor(33, 150, 243);
                doc.rect(margin, yPos - 5, pageWidth - 2*margin, 10, 'F');
                doc.text('2. QUALITY CONTROL PASS INPUT', margin + 10, yPos + 2);
                
                yPos += 10;
                
                // QC Table Header
                doc.setFillColor(26, 35, 126);
                doc.rect(margin, yPos, pageWidth - 2*margin, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                
                const qcColWidths = [40, 35, 30, 40, 25];
                const qcColPositions = calculateColumnPositions(margin, qcColWidths, pageWidth);
                
                doc.text('Buyer', qcColPositions[0] + 5, yPos + 6);
                doc.text('Style Code', qcColPositions[1] + 5, yPos + 6);
                doc.text('Colour', qcColPositions[2] + 5, yPos + 6);
                doc.text('Wash Type', qcColPositions[3] + 5, yPos + 6);
                doc.text('Passed Qty', qcColPositions[4] + qcColWidths[4] - 5, yPos + 6, { align: 'right' });
                
                yPos += 10;
                
                // QC Table Data
                let qcRowIndex = 0;
                let qcPageStart = 0;
                const qcMaxRowsPerPage = Math.floor((pageHeight - yPos - 50) / 6);
                
                for (let i = 0; i < reportData.qcData.length; i++) {
                    const item = reportData.qcData[i];
                    
                    // Check if we need a new page
                    if (qcRowIndex >= qcMaxRowsPerPage) {
                        addPageFooter(doc, currentPage, totalPages);
                        doc.addPage();
                        currentPage++;
                        yPos = margin;
                        
                        // Add continuation header
                        doc.setTextColor(26, 35, 126);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text('QUALITY CONTROL PASS (Continued)', margin, yPos);
                        yPos += 15;
                        
                        // Repeat table header
                        doc.setFillColor(26, 35, 126);
                        doc.rect(margin, yPos, pageWidth - 2*margin, 8, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Buyer', qcColPositions[0] + 5, yPos + 6);
                        doc.text('Style Code', qcColPositions[1] + 5, yPos + 6);
                        doc.text('Colour', qcColPositions[2] + 5, yPos + 6);
                        doc.text('Wash Type', qcColPositions[3] + 5, yPos + 6);
                        doc.text('Passed Qty', qcColPositions[4] + qcColWidths[4] - 5, yPos + 6, { align: 'right' });
                        yPos += 10;
                        
                        qcRowIndex = 0;
                        qcPageStart = i;
                    }
                    
                    // Alternate row colors
                    if (qcRowIndex % 2 === 0) {
                        doc.setFillColor(245, 245, 245);
                        doc.rect(margin, yPos - 4, pageWidth - 2*margin, 6, 'F');
                    }
                    
                    // Set text color for re-wash
                    if (item.washType === 'Re-Wash') {
                        doc.setTextColor(255, 87, 34);
                        doc.setFont('helvetica', 'bold');
                    } else {
                        doc.setTextColor(66, 66, 66);
                        doc.setFont('helvetica', 'normal');
                    }
                    
                    doc.text(item.buyer.substring(0, 15), qcColPositions[0] + 5, yPos);
                    doc.text(item.style.substring(0, 12), qcColPositions[1] + 5, yPos);
                    doc.text(item.colorCode.substring(0, 10), qcColPositions[2] + 5, yPos);
                    doc.text(item.washType, qcColPositions[3] + 5, yPos);
                    doc.text(item.passedQuantity.toLocaleString(), qcColPositions[4] + qcColWidths[4] - 5, yPos, { align: 'right' });
                    
                    yPos += 6;
                    qcRowIndex++;
                }
                
                // QC Total
                yPos += 5;
                doc.setDrawColor(33, 150, 243);
                doc.setLineWidth(0.5);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 5;
                
                doc.setFillColor(227, 242, 253);
                doc.rect(margin, yPos - 4, pageWidth - 2*margin, 8, 'F');
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('TOTAL QC PASS', qcColPositions[3] + 5, yPos);
                doc.text(reportData.qcTotal.toLocaleString() + ' pcs', 
                        qcColPositions[4] + qcColWidths[4] - 5, yPos, { align: 'right' });
                
                // ====== PANEL WASH SECTION ======
                yPos += 20;
                
                // Check if we need a new page for panel wash
                if (yPos > pageHeight - 50) {
                    addPageFooter(doc, currentPage, totalPages);
                    doc.addPage();
                    currentPage++;
                    yPos = margin;
                }
                
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.setFillColor(255, 193, 7);
                doc.rect(margin, yPos - 5, pageWidth - 2*margin, 10, 'F');
                doc.text('3. PANEL WASH SUMMARY', margin + 10, yPos + 2);
                
                yPos += 15;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('Total Roll Processed:', margin + 10, yPos);
                
                yPos += 10;
                doc.setFontSize(36);
                doc.text(`${reportData.panelWashRolls}`, margin + 10, yPos);
                doc.setFontSize(24);
                doc.text('rolls', margin + 50, yPos);
                
                // Add footer to last page
                addPageFooter(doc, currentPage, totalPages);
                
                // Save PDF
                const fileName = `FAKIR_Report_${reportData.date.replace(/-/g, '')}_${reportData.reportId}.pdf`;
                doc.save(fileName);
                
                showToast('âœ… Multi-page PDF report generated successfully!', 'success');
                
            } catch (error) {
                console.error('PDF generation error:', error);
                showToast('Failed to generate PDF report', 'error');
            } finally {
                hideLoading();
            }
        }

        function calculateTotalPages() {
            const pageHeight = 297; // A4 height in mm
            const margin = 20;
            const headerHeight = 100;
            const rowHeight = 6;
            const sectionSpacing = 40;
            
            let pages = 1;
            let currentHeight = margin + headerHeight;
            
            // Production section
            const prodRows = reportData.productionData.length;
            const prodHeaderHeight = 20;
            const prodTableHeight = prodHeaderHeight + (prodRows * rowHeight) + 20; // +20 for total row
            
            if (currentHeight + prodTableHeight > pageHeight - 50) {
                pages += Math.ceil(prodTableHeight / (pageHeight - 100));
                currentHeight = margin + 50; // Reset for new page
            } else {
                currentHeight += prodTableHeight + sectionSpacing;
            }
            
            // QC section
            const qcRows = reportData.qcData.length;
            const qcHeaderHeight = 20;
            const qcTableHeight = qcHeaderHeight + (qcRows * rowHeight) + 20; // +20 for total row
            
            if (currentHeight + qcTableHeight > pageHeight - 50) {
                pages += Math.ceil(qcTableHeight / (pageHeight - 100));
                currentHeight = margin + 50; // Reset for new page
            } else {
                currentHeight += qcTableHeight + sectionSpacing;
            }
            
            // Panel wash section (40mm height)
            if (currentHeight + 40 > pageHeight - 50) {
                pages++;
            }
            
            return Math.max(1, pages);
        }

        function calculateTableHeight(rowCount) {
            const headerHeight = 20;
            const rowHeight = 6;
            const totalRowHeight = 15;
            return headerHeight + (rowCount * rowHeight) + totalRowHeight;
        }

        function calculateColumnPositions(startX, colWidths, pageWidth) {
            const positions = [startX];
            let currentX = startX;
            
            for (let i = 0; i < colWidths.length - 1; i++) {
                currentX += colWidths[i];
                positions.push(currentX);
            }
            
            // Adjust last column to fit page width
            const totalWidth = colWidths.reduce((a, b) => a + b, 0);
            if (totalWidth < pageWidth - 2*startX) {
                positions[positions.length - 1] = pageWidth - startX - colWidths[colWidths.length - 1];
            }
            
            return positions;
        }

        function addPageFooter(doc, currentPage, totalPages) {
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.setFont('helvetica', 'normal');
            
            // Page number
            doc.text(`Page ${currentPage} of ${totalPages}`, pageWidth/2, pageHeight - 15, { align: 'center' });
            
            // Footer text
            const footerText = 'Fakir Apparels Ltd | Washing Plant | Software Designed by Md Naimur Rashid, Ex. Washing Plant';
            doc.text(footerText, pageWidth/2, pageHeight - 10, { align: 'center' });
            
            // Generation info
            const genInfo = `Generated: ${new Date().toLocaleString()} | Report ID: ${reportData.reportId}`;
            doc.text(genInfo, pageWidth/2, pageHeight - 5, { align: 'center' });
        }

        // ========== PNG REPORT GENERATION ==========
        async function generatePNGReport() {
            if (!reportData) {
                const lastReport = localStorage.getItem('last_report_data');
                if (lastReport) {
                    reportData = JSON.parse(lastReport);
                } else {
                    showToast('Please submit data first', 'error');
                    return;
                }
            }
            
            showLoading('Generating PNG report...');
            
            try {
                // Generate HTML for each page
                const pagesHTML = generateMultiPageHTML(reportData);
                const canvases = [];
                
                // Create iframe for each page
                for (let i = 0; i < pagesHTML.length; i++) {
                    const iframe = document.createElement('iframe');
                    iframe.style.cssText = `
                        position: absolute;
                        width: 210mm;
                        height: 297mm;
                        top: -9999px;
                        left: -9999px;
                        border: none;
                    `;
                    document.body.appendChild(iframe);
                    
                    iframe.contentDocument.open();
                    iframe.contentDocument.write(pagesHTML[i]);
                    iframe.contentDocument.close();
                    
                    await new Promise(resolve => {
                        iframe.onload = resolve;
                        setTimeout(resolve, 500);
                    });
                    
                    await loadHtml2Canvas();
                    
                    const canvas = await html2canvas(iframe.contentDocument.body, {
                        scale: 3,
                        backgroundColor: '#ffffff',
                        useCORS: true,
                        logging: false,
                        width: 1240,
                        height: 1754
                    });
                    
                    canvases.push(canvas);
                    document.body.removeChild(iframe);
                }
                
                // Display first page in preview
                const dataURL = canvases[0].toDataURL('image/png', 1.0);
                displayGeneratedReport(dataURL);
                
                // Save all pages to localStorage
                const allPagesData = canvases.map(canvas => canvas.toDataURL('image/png', 1.0));
                localStorage.setItem('last_generated_report', JSON.stringify(allPagesData));
                
                showToast(`ðŸŽ‰ ${pagesHTML.length}-page PNG report generated!`, 'success');
                
            } catch (error) {
                console.error('Report generation error:', error);
                showToast('Failed to generate report', 'error');
            } finally {
                hideLoading();
            }
        }

        function generateMultiPageHTML(data) {
            const formattedDate = new Date(data.date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const pages = [];
            let currentPage = 1;
            const totalPages = calculateTotalPages();
            
            // Page 1 HTML
            let page1HTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <style>
                    @page { size: A4; margin: 0; }
                    body { 
                        font-family: Arial, sans-serif; 
                        margin: 0; 
                        padding: 25px; 
                        background: white;
                        color: black;
                        width: 210mm;
                        min-height: 297mm;
                        position: relative;
                    }
                    .report-container {
                        border: 4px solid #1a237e;
                        border-radius: 15px;
                        padding: 30px;
                        min-height: 267mm;
                        position: relative;
                        background: white;
                    }
                    .header {
                        text-align: center;
                        margin-bottom: 30px;
                        padding-bottom: 25px;
                        border-bottom: 4px solid #1a237e;
                    }
                    .company-name {
                        color: #1a237e;
                        font-size: 40px;
                        font-weight: bold;
                        margin-bottom: 10px;
                        text-transform: uppercase;
                    }
                    .department {
                        color: #283593;
                        font-size: 32px;
                        font-weight: 600;
                        margin-bottom: 15px;
                    }
                    .details {
                        display: flex;
                        justify-content: space-between;
                        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                        padding: 25px;
                        border-radius: 12px;
                        margin-bottom: 35px;
                        border: 2px solid #dee2e6;
                        font-size: 18px;
                    }
                    .section {
                        margin-bottom: 35px;
                    }
                    .section-title {
                        background: linear-gradient(135deg, #1a237e, #283593);
                        color: white;
                        padding: 18px 25px;
                        font-size: 24px;
                        font-weight: bold;
                        border-radius: 10px;
                        margin-bottom: 20px;
                    }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-bottom: 20px;
                        font-size: 16px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    }
                    th {
                        background: #2e7d32;
                        color: white;
                        padding: 16px;
                        text-align: left;
                        font-weight: bold;
                        font-size: 18px;
                        border: 1px solid #1b5e20;
                    }
                    td {
                        padding: 14px 16px;
                        border: 1px solid #ddd;
                        font-size: 16px;
                    }
                    .total-row {
                        background: #e8f5e9;
                        font-weight: bold;
                        border-top: 3px solid #2e7d32;
                        font-size: 18px;
                    }
                    .footer {
                        position: absolute;
                        bottom: 25px;
                        left: 30px;
                        right: 30px;
                        text-align: center;
                        padding-top: 20px;
                        border-top: 2px solid #ccc;
                        font-size: 14px;
                        color: #666;
                        background: white;
                    }
                    .watermark {
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%) rotate(-45deg);
                        font-size: 120px;
                        color: rgba(26, 35, 126, 0.05);
                        font-weight: bold;
                        z-index: -1;
                        pointer-events: none;
                    }
                    .page-number {
                        position: absolute;
                        bottom: 10px;
                        right: 30px;
                        font-size: 12px;
                        color: #666;
                    }
                </style>
            </head>
            <body>
                <div class="report-container">
                    <div class="watermark">FAKIR APPARELS</div>
                    
                    <div class="header">
                        <div class="company-name">FAKIR APPARELS LTD</div>
                        <div class="department">Washing Plant - Daily Report</div>
                    </div>
                    
                    <div class="details">
                        <div>
                            <strong>Date:</strong> ${escapeHTML(formattedDate)}<br>
                            <strong>Shift Responsible:</strong> ${escapeHTML(data.shiftResponsible)}
                        </div>
                        <div>
                            <strong>Supervisor:</strong> ${escapeHTML(data.supervisor)}<br>
                            <strong>Report ID:</strong> ${data.reportId}
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">1. PRODUCTION INPUT</div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Buyer</th>
                                    <th>Style</th>
                                    <th>Colour Code</th>
                                    <th>Type of Wash</th>
                                    <th>Quantity (pcs)</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            // Add first 15 production rows (or all if less)
            const prodRowsPerPage = 15;
            const prodRowsToShow = Math.min(data.productionData.length, prodRowsPerPage);
            
            for (let i = 0; i < prodRowsToShow; i++) {
                const row = data.productionData[i];
                const isReWash = row.washType === 'Re-Wash';
                page1HTML += `
                    <tr style="${isReWash ? 'background-color: #fff8e1; font-weight: bold;' : ''}">
                        <td>${escapeHTML(row.buyer)}</td>
                        <td>${escapeHTML(row.style)}</td>
                        <td>${escapeHTML(row.colorCode)}</td>
                        <td style="${isReWash ? 'color: #ff9800; font-weight: bold;' : ''}">${escapeHTML(row.washType)}</td>
                        <td style="text-align: right; font-weight: bold;">${row.quantity.toLocaleString()}</td>
                    </tr>`;
            }
            
            // Add "Continued on next page" if needed
            if (data.productionData.length > prodRowsPerPage) {
                page1HTML += `
                    <tr>
                        <td colspan="5" style="text-align: center; font-style: italic; color: #666; padding: 20px;">
                            Continued on next page...
                        </td>
                    </tr>`;
            } else {
                // Add total row if all production data fits on first page
                page1HTML += `
                    <tr class="total-row">
                        <td colspan="4" style="text-align: right; padding-right: 30px;">
                            <strong>TOTAL PRODUCTION:</strong>
                        </td>
                        <td style="text-align: right; font-size: 20px;">
                            <strong>${data.productionTotal.toLocaleString()} pcs</strong>
                        </td>
                    </tr>`;
            }
            
            page1HTML += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="footer">
                        <div>Fakir Apparels Ltd | Washing Plant | Software Designed by Md Naimur Rashid, Ex. Washing Plant</div>
                        <div style="margin-top: 10px; color: #999;">Page ${currentPage} of ${totalPages} | Generated: ${new Date(data.submissionTime).toLocaleString()}</div>
                    </div>
                </div>
            </body>
            </html>`;
            
            pages.push(page1HTML);
            
            // Generate additional pages if needed
            // (Additional pages HTML generation logic would go here)
            
            return pages;
        }

        function displayGeneratedReport(dataURL) {
            reportPlaceholder.classList.add('hidden');
            generatedReportImg.src = dataURL;
            generatedReportImg.classList.remove('hidden');
            reportPreview.classList.remove('hidden');
            downloadReportBtn.disabled = false;
            
            setTimeout(() => {
                reportPreview.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }

        // ========== UTILITY FUNCTIONS ==========
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function showLoading(message) {
            loadingText.textContent = message;
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function showToast(message, type = 'info') {
            document.querySelectorAll('.toast').forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas ${getToastIcon(type)}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(-50%) translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function getToastIcon(type) {
            switch(type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                default: return 'fa-info-circle';
            }
        }

        function escapeHTML(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showAppScreen() {
            loginScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');
            loggedInSupervisorEl.textContent = currentSupervisor.name;
            
            loadFormState();
            
            const lastReport = localStorage.getItem('last_generated_report');
            if (lastReport) {
                try {
                    const reportData = JSON.parse(lastReport);
                    if (Array.isArray(reportData)) {
                        // Multi-page report
                        reportPlaceholder.classList.add('hidden');
                        generatedReportImg.src = reportData[0];
                        generatedReportImg.classList.remove('hidden');
                        reportPreview.classList.remove('hidden');
                        downloadReportBtn.disabled = false;
                    } else {
                        // Single page report
                        reportPlaceholder.classList.add('hidden');
                        generatedReportImg.src = lastReport;
                        generatedReportImg.classList.remove('hidden');
                        reportPreview.classList.remove('hidden');
                        downloadReportBtn.disabled = false;
                    }
                } catch (e) {
                    // Old format - single image
                    reportPlaceholder.classList.add('hidden');
                    generatedReportImg.src = lastReport;
                    generatedReportImg.classList.remove('hidden');
                    reportPreview.classList.remove('hidden');
                    downloadReportBtn.disabled = false;
                }
            }
        }

        function saveFormState() {
            const formState = {
                date: reportDate.value,
                shiftResponsible: shiftResponsible.value,
                panelWashRolls: panelWashRolls.value,
                productionRows: [],
                qcRows: []
            };
            
            document.querySelectorAll('.production-row').forEach(row => {
                formState.productionRows.push({
                    buyer: row.querySelector('.buyer-input')?.value || '',
                    style: row.querySelector('.style-input')?.value || '',
                    color: row.querySelector('.color-input')?.value || '',
                    washType: row.querySelector('.wash-type')?.value || 'Fresh',
                    quantity: row.querySelector('.quantity-input')?.value || ''
                });
            });
            
            document.querySelectorAll('.qc-row').forEach(row => {
                formState.qcRows.push({
                    buyer: row.querySelector('.qc-buyer')?.value || '',
                    style: row.querySelector('.qc-style')?.value || '',
                    color: row.querySelector('.qc-color')?.value || '',
                    washType: row.querySelector('.qc-wash-type')?.value || 'Fresh',
                    quantity: row.querySelector('.qc-quantity')?.value || ''
                });
            });
            
            localStorage.setItem('fakir_form_state', JSON.stringify(formState));
        }

        function loadFormState() {
            const saved = localStorage.getItem('fakir_form_state');
            if (!saved) return;
            
            try {
                const state = JSON.parse(saved);
                
                if (state.date) reportDate.value = state.date;
                if (state.shiftResponsible) shiftResponsible.value = state.shiftResponsible;
                if (state.panelWashRolls) panelWashRolls.value = state.panelWashRolls;
                
                productionTableBody.innerHTML = '';
                qcTableBody.innerHTML = '';
                
                if (state.productionRows && state.productionRows.length > 0) {
                    state.productionRows.forEach(rowData => {
                        const row = document.createElement('tr');
                        row.className = 'production-row';
                        row.innerHTML = `
                            <td><input type="text" class="buyer-input" value="${escapeHTML(rowData.buyer)}" required></td>
                            <td><input type="text" class="style-input" value="${escapeHTML(rowData.style)}" required></td>
                            <td><input type="text" class="color-input" value="${escapeHTML(rowData.color)}" required></td>
                            <td>
                                <select class="wash-type">
                                    <option value="Fresh" ${rowData.washType === 'Fresh' ? 'selected' : ''}>Fresh Wash</option>
                                    <option value="Re-Wash" ${rowData.washType === 'Re-Wash' ? 'selected' : ''}>Re-Wash</option>
                                </select>
                            </td>
                            <td><input type="number" class="quantity-input" value="${rowData.quantity}" required></td>
                            <td><button class="btn-remove-row" onclick="removeRow(this, 'production')"><i class="fas fa-times"></i></button></td>
                        `;
                        productionTableBody.appendChild(row);
                    });
                } else {
                    addProductionRow(true);
                }
                
                if (state.qcRows && state.qcRows.length > 0) {
                    state.qcRows.forEach(rowData => {
                        const row = document.createElement('tr');
                        row.className = 'qc-row';
                        row.innerHTML = `
                            <td><input type="text" class="qc-buyer" value="${escapeHTML(rowData.buyer)}" required></td>
                            <td><input type="text" class="qc-style" value="${escapeHTML(rowData.style)}" required></td>
                            <td><input type="text" class="qc-color" value="${escapeHTML(rowData.color)}" required></td>
                            <td>
                                <select class="qc-wash-type">
                                    <option value="Fresh" ${rowData.washType === 'Fresh' ? 'selected' : ''}>Fresh Wash</option>
                                    <option value="Re-Wash" ${rowData.washType === 'Re-Wash' ? 'selected' : ''}>Re-Wash</option>
                                </select>
                            </td>
                            <td><input type="number" class="qc-quantity" value="${rowData.quantity}" required></td>
                            <td><button class="btn-remove-row" onclick="removeRow(this, 'qc')"><i class="fas fa-times"></i></button></td>
                        `;
                        qcTableBody.appendChild(row);
                    });
                } else {
                    addQcRow(true);
                }
                
                calculateTotals();
                
            } catch (e) {
                console.error('Error loading form state:', e);
            }
        }

        function downloadReport() {
            const lastReport = localStorage.getItem('last_generated_report');
            if (!lastReport) {
                showToast('No report to download', 'error');
                return;
            }
            
            try {
                const reportData = JSON.parse(lastReport);
                if (Array.isArray(reportData)) {
                    // Multi-page report - download as ZIP
                    showToast('Multi-page reports will be downloaded as ZIP file', 'info');
                    // For now, download first page
                    downloadImage(reportData[0], 1);
                } else {
                    // Single page report
                    downloadImage(lastReport, 1);
                }
            } catch (e) {
                // Old format - single image
                downloadImage(lastReport, 1);
            }
        }

        function downloadImage(dataURL, pageNumber) {
            const link = document.createElement('a');
            const fileName = `FAKIR_Report_${reportData.date.replace(/-/g, '_')}_Page${pageNumber}.png`;
            
            link.href = dataURL;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast(`âœ… Page ${pageNumber} downloaded!`, 'success');
        }

        function shareReport() {
            if (!generatedReportImg.src || generatedReportImg.src.includes('placeholder')) {
                showToast('No report to share', 'error');
                return;
            }
            
            if (navigator.share) {
                navigator.share({
                    title: `Fakir Apparels Washing Report - ${reportData.date}`,
                    text: `Daily washing production report for ${reportData.date}`,
                    url: generatedReportImg.src
                }).catch(error => {
                    console.log('Sharing failed:', error);
                    showToast('Sharing not supported on this device', 'info');
                });
            } else {
                showToast('Sharing not supported on this browser', 'info');
            }
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('fakir_session');
                currentSupervisor = null;
                reportData = null;
                
                appScreen.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                
                loginPassword.value = '';
                supervisorName.value = '';
                
                showToast('Logged out successfully', 'info');
            }
        }

        async function loadHtml2Canvas() {
            return new Promise((resolve, reject) => {
                if (typeof html2canvas !== 'undefined') {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // ========== MAKE FUNCTIONS GLOBALLY AVAILABLE ==========
        window.removeRow = removeRow;
        
    </script>
</body>
</html>
